<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pizza Login</title>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <head href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: linear-gradient(to right, #ff4d4d, #ff9900);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
      }

      .wrapper {
        width: 100%;
        max-width: 400px;
        padding: 2rem;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .wrapper h1 {
        font-size: 2rem;
        text-align: center;
        color: #ff4d4d;
        margin-bottom: 1.5rem;
      }

      .input-box {
        position: relative;
        margin-bottom: 1.5rem;
      }

      .input-box input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #eee;
        border-radius: 10px;
        font-size: 1rem;
        transition: 0.3s;
      }

      .input-box input:focus {
        border-color: #ff4d4d;
        outline: none;
      }

      .input-box i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }

      .remember-forgot {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .remember-forgot a {
        text-decoration: none;
        color: #ff4d4d;
      }

      .remember-forgot a:hover {
        text-decoration: underline;
      }

      .btn {
        width: 100%;
        padding: 0.75rem;
        background-color: #ff4d4d;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
      }

      .btn:hover {
        background-color: #e63946;
      }

      .register-link {
        text-align: center;
        font-size: 0.95rem;
        margin-top: 1rem;
      }

      .register-link a {
        color: #ff4d4d;
        text-decoration: none;
        font-weight: 600;
      }

      .register-link a:hover {
        text-decoration: underline;
      }
    </style>
  </head>

<body>
  <div class="wrapper">
    <form id="login-form">
      <h1>Login</h1>
      <div class="input-box">
        <input type="text" id="username" placeholder="Username" required>
        <i class='bx bxs-user'></i>
      </div>
      <div class="input-box">
        <input type="password" id="password" placeholder="Password" required>
        <i class='bx bxs-lock-alt'></i>
      </div>


      
      <div class="remember-forgot">
        <label><input type="checkbox"> Remember Me</label>
        <label><input type="checkbox" id="isStaffChecked"> Is Staff</label>
      </div>
      <button type="submit" class="btn">Login</button>
      <div class="register-link">
        <p>Don't have an account? <a href="/auth/signup">Register</a></p>
      </div>
    </form>
  </div>
  <script>
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const isStaffChecked = document.getElementById("isStaffChecked").checked;
      const refreshToken = localStorage.getItem("refresh_token");
      const accessToken = localStorage.getItem("access_token");

      const response = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      // async function refreshToken() {
      //   const refreshToken = localStorage.getItem("refresh_token");
      //   if (!refreshToken) return false;

      //   try {
      //     const res = await fetch("/auth/refresh", {
      //       headers: {
      //         Authorization: `Bearer ${refreshToken}`
      //       }
      //     });

      //     if (res.ok) {
      //       const data = await res.json();
      //       localStorage.setItem("token", data.access);
      //       return true;
      //     } else {
      //       console.warn("Failed to refresh token");
      //       return false;
      //     }
      //   } catch (err) {
      //     console.error("Error refreshing token", err);
      //     return false;
      //   }
      // }

      // // Call this only once after successful login
      // function startTokenRefreshTimer() {
      //   const refreshInterval = 9 * 60 * 1000; // 9 minutes

      //   setInterval(async () => {
      //     const success = await refreshToken();
      //     if (!success) {
      //       alert("Session expired. Please log in again.");
      //       localStorage.clear();
      //       window.location.href = "/auth/login";
      //     }
      //   }, refreshInterval);
      // }

      const data = await response.json();
      console.log(data)

      if (response.ok) {
        if (isStaffChecked && !data.is_staff) {
          alert("You are not authorized as staff. Please login as a regular user.");
          return;
        }

        localStorage.setItem("token", data.access);
        alert("Login successful!");
        // startTokenRefreshTimer();

        // Redirect based on role
        if (data.is_staff) {
          localStorage.setItem("admin_token", data.access);
        } else {
          localStorage.setItem("user_token", data.access);
        }

        window.location.href = data.is_staff ? "/admin/dashboard" : "/user/dashboard";
      } else {
        alert(data.detail || "Login failed.");
      }
      console.log(data)
    });
  </script>


</body>

</html>